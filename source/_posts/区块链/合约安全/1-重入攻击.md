---
title: 1-重入攻击

date: 2023-04-16	

categories: 合约安全	

tags: [区块链,合约安全]
---	

# 重入攻击

每当一个智能合约调用另一个智能合约的函数，向其发送以太币，或向其代币转账，那么就有可能出现重入。

重入攻击的类型可以分为：
（1）单函数重入
（2）跨函数重入
（3）跨合约重入

## 分类

### 单函数重入

当一个易受攻击的函数是攻击者试图递归调用的同一个函数时，就会发生单函数重入攻击。
![image.png](/noteimg/C:/Users/zhuba/Desktop/PersonalBlog/source/_posts/区块链/合约安全/img/Z5jDNDcI63130b6cc6bb8.png)
在此示例中，注释（1）部分进行资金转移之后，才对注释（2）账户余额状态进行修改。这时候，会让黑客可以在状态修改之前利用fallback()函数多次调用该函数，直至取走合约账户内的全部余额。

### 跨函数重入

当一个易受攻击的函数与一个可被攻击者利用的函数共享状态时，就会发生跨函数重入。
![image.png](/noteimg/C:/Users/zhuba/Desktop/PersonalBlog/source/_posts/区块链/合约安全/img/I2v9TxrD63130b7626179.png)
在此示例中，黑客可以利用fallback()操作该合约，外部调用transfer()函数，在合约余额状态设置为0之前，进行转移资金。虽然该合约能接受到取款，但是也可以转移资金。
跨函数重入和单函数重入在同一个合约中，也有不在同一个合约，重入可以发生在跨多个合约，便是多个合约共享同一个状态。

### 跨合约重入

当一个合约中的一个状态在另一个合约中使用，但在被调用之前未完全更新时，可能会发生跨合约重入。
跨合约重入所需以下条件：
（1）一个合约中的状态在另一个合约中共享或者使用
（2）攻击者可以通过利用执行流来操纵合约的状态

## 预防

1）对于单函数重入、跨函数重入，可以在合约中实现互斥锁，用来防止重复调用同一个合约中的函数，从而防止重入
![image.png](/noteimg/C:/Users/zhuba/Desktop/PersonalBlog/source/_posts/区块链/合约安全/img/cfrZPT1N63130d45b197d.png)
（2）在调用外部合约或所谓的“检查-生效-交互”模式之前检查并尝试更新所有状态。这样，即使重入，也不会产生任何影响，因为所有状态都已完成更新(先更新后交互)
![image.png](/noteimg/C:/Users/zhuba/Desktop/PersonalBlog/source/_posts/区块链/合约安全/img/ndIhRCb363130d4f90527.png)
（3）防止攻击者利用合约的控制流。设置一组列入白名单的地址，可以防止攻击者将未知的恶意合约注入合约
（4）gas限制可以防止重入攻击，但这不应该被视为一种安全策略，因为gas成本取决于以太坊的操作码，这些操作码可能会发生变化。另一方面，智能合约代码是不可变的。无论如何，有必要了解这些函数之间的区别：send，transfer和call。send和transfer的函数本质上是相同的，但如果事务失败，transfer将恢复，而send则不会。关于重入，send和transfer都有2300个单位的gas限制。使用这些函数应该可以防止发生重入攻击，因为这不足以递归回调源函数来利用资金
（5)使用自动化的智能合约审计扫描工具或需求专业的第三方审计团队的帮助，也可以帮助检测重入错误。