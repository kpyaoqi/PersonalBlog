---
title: 链拍

date: 2023-04-09	

categories: 区块链项目	

tags: [区块链,区块链项目]
---	

## 简介

该项目是通过truffle与webpack快速搭建的Dapp项目，利用solidity编写的智能合约实现该拍卖系统的逻辑部分，大概流程为上传拍品，进行出价，拍卖时间结束后会进行揭示报价等，结果会由买家卖家和仲裁人三方决定交易是否成功，进行出价未成功的用户通过托管合约退回之前出价金额，主要运用web3.js和ethers.js、truffle和solidity、IPFS其中主要的数据结构有：

```solidity
	// 商品结构体
    struct Product {
        // 商品ID
        uint256 id;
        // 商品名字
        string name;
        // 商品类别
        string category;
        // 商品图片链接
        string imageLink;
        // 商品描述文本链接
        string descLink;
        // 开始拍卖时间
        uint256 auctionStartTime;
        // 结束拍卖时间
        uint256 auctionEndTime;
        // 起拍价
        uint256 startPrice;
        // 最高出价人地址
        address highestBidder;
        // 最高价
        uint256 highestBid;
        // 第二高出价人出价
        uint256 secondHighestBid;
        // 总共出价
        uint256 totalBids;
        // 商品状态
        ProductStatus status;
        ProductCondition condition;
        // 竞拍人详情
        mapping(address => mapping(bytes32 => Bid)) bids;
    }
    
    // 竞拍人报价信息
    struct Bid {
        address bidder;
        uint256 productId;
        uint256 value;
        bool revealed;
    }
```

## 内部主要逻辑

### 上传拍品

传入相关参数进行拍品上链，其中利用了订阅监听拍品上链的事件，并将拍品信息保存到数据库中，前端页面显示的时候也是通过查询数据库，这样更高效方便，上传拍品还使用了IPFS进行保存拍品的图片和描述信息

```js
this.EcommerceStore.events.NewProduct({
      fromBlock: 'latest'
    }, function (error, result) {
      // 结果包含 非索引参数 以及 主题 topic
      if (error) {
        console.log(error);
        return;
      }
      var product = result.returnValues;
      that.fun.saveProduct(product);
    });
```

#### 讲讲项目中的ipfs？

通过拍品图片和描述上传到IPFS后接受的返回值(唯一标识符CID)保存到拍品信息中并上链和保存到数据库，查询商品信息是也是通过查询IPFS返回数据来进行展示。

#### 为什么想到用ipfs（基于内容，gas贵）

首先在以太坊本身并不直接支持存储大型文件，包括图片的，IPFS也是去中心化的文件系统，防篡改的，它是基于内容寻址，拍品的照片和一些较长的描述信息保存在IPFS还能节省Gas，但目前由于IPFS的关系，可能导致文件丢失，付费购买稳定的IPFS存储

#### IPFS

IPFS的设计目标之一是提供高可用性和冗余性，以减少文件丢失的风险。由于IPFS使用分布式存储的方式，文件会被分散存储在全球网络的多个节点上。这意味着即使某个节点不可用或文件被删除，其他节点仍然可能拥有该文件的副本。

#### 丢失

1. 节点离线：如果**存储文件的节点离线并且没有其他节点拥有该文件的副本**，那么该文件将暂时无法访问，直到节点重新上线或其他节点重新存储该文件。
2. 文件丢失：如果**所有存储文件的节点都意外丢失了该文件**，那么文件可能无法找回。
3. 不活跃的文件：IPFS使用内容寻址，文件的标识是基于其内容的哈希值。如果**某个文件在网络中不活跃（即没有被频繁访问或传输）**，那么**可能会存在较少的节点存储该文件，增加了文件丢失的风险。**

### 出价

出价的时候会有一个输入出价价格和实际出价价格，如果出价<实际出价则出价失败，在揭示报价时会回退出价，但可以迷惑别的竞拍选手，因为出价也是上链所有人可以查到，其中还需要输入一个密文，在揭示报价也需要这个密文

### 揭示报价

输入密文进行揭示，到拍品结束结束都可以进行，其中未及时揭示报价的用户会退还之前的报价

### 托管合约

创建一个 Multisig Escrow（多重签名托管）合约，里面存放了了买方赢得拍卖的数量，买方，卖方和一个任意的第三方是参与者。托管的资金只能被释放给卖方，或是返回给买方，并且至少需要三个参与者中的两个同意才能执行。

在接下来的几节，我们将会实现托管合约，并当拍卖结束时，在运行时添加创建一个以太坊托管合约的功能。

## 升级插件

使用的是OpenZeppelin升级插件，在部署一个可升级的智能合约时实际上部署了三个合约： 

1. 您编写的合约，称为包含逻辑的实施合约。
2. ProxyAdmin是代理的管理员。
3. 执行合同的代理，这是您实际与之交互的合同。

在这里 ，代理是一个简单的协定，它只是**将所有调用委托给实现协定**。 委托调用类似于常规调用，不同之处在于**所有代码都在调用方的上下文中执行，而不是在被调用方的上下文中执行**。正因为如此，一个  `transfer`在实现合约的代码中，实际上将传输代理的余额，对合约存储的任何读取或写入都将从代理自己的存储中读取或写入。 

这允许我们将 **合约的状态和代码解耦** ：代理保存状态，而实现合约提供代码。智能合约的任何用户始终与代理交互， **代理永远不会更改其地址** 。这允许您推出升级或修复错误，而无需要求用户更改任何内容 - 他们只是一如既往地与相同的地址进行交互。 