---
title: 3-PBFT

date: 2023-01-27	

categories: 共识算法	

tags: [区块链,区块链知识点总结,共识算法]
---	

## PBFT **实用拜占庭容错算法**

### 拜占庭将军问题

一组拜占庭将军分别各率领一支军队共同围困一座城市。为了简化问题，将各支军队的行动策略限定为进攻或撤离两种。因为部分军队进攻部分军队撤离可能会造成灾难性后果，因此各位将军必须通过投票来达成一致策略，即所有军队一起进攻或所有军队一起撤离。因为各位将军分处城市不同方向，他们只能通过信使互相联系。**因此，将军们必须有一个预定的方法协议，使所有忠诚的将军够达成一致**。而且少数几个叛徒不能使忠诚的将军做出错误的计划。**也就是说，拜占庭将军问题的实质就是要寻找一个方法，使得将军们在一个有版徒的非信任环境中建立对战斗计划的共识**。

在该模型下，**系统不会对集群中的节点做任何的限制**，它们可以向其他节点发送随机数据、错误数据，也可以选择不响应其他节点的请求，这些无法预测的行为使得容错这一问题变得更加复杂。**拜占庭将军问题是对分布式系统容错的最高要求**。 ![image-20230321100125432](/noteimg/C:/Users/zhuba/Desktop/PersonalBlog/source/_posts/区块链/区块链知识点总结/共识算法/img/image-20230321100125432.png)

其中C为发送请求端，0123为服务端，3为宕机的服务端，具体步骤如下：

1. Request请求阶段：请求端C发送请求到主节点0
2. Pre-Prepare预准备阶段：客户端请求消息签名是否正确，然后广播给其他副本节点
3. Prepare准备阶段：123收到后记录并再次广播，1->023，2->013，3因为宕机无法广播
4. Commit提交阶段：如果副本节点收到了2f个验证通过的PREPARE消息，则广播Commit请求
5. Reply响应阶段：如果副本节点i收到了2f+1个验证通过的COMMIT消息，备份节点在执行完请求后，将结果发送给客户端，则对C进行反馈

## PBFT算法的运作原理

1. 取一个副本作为主节点，其他的副本作为备份
2. **用户端向主节点发送使用服务操作的请求**
3. **主节点通过广播将请求发送给其他副本**
4. 所有**副本执行请求并将结果发回用户端**
5. 用户端需要**等待F+1个不同副本节点发回相同的结果**，作为整个操作的最终结果。

## 主节点的选择

在PBFT算法中，主节点的选择是通过一种基于视图号（View）和轮次（Round）的选举机制完成的。以下是主节点选择的基本过程：

1. **视图切换：**
   - PBFT算法中的视图是一个递增的编号，代表了系统中的不同状态。
   - 初始状态下，系统进入视图1。
   - **如果系统中的节点检测到当前视图的主节点发生故障或无法正常运行，它们可以发起视图切换**。
2. **视图切换请求：**
   - **当节点检测到主节点故障时，它们会广播一个视图切换请求。**
   - **视图切换请求包含了提议新主节点的信息，**如节点的标识符和签名。
3. **视图切换预准备：**
   - 其他节点在收到视图切换请求后，首先验证请求的合法性。
   - **如果请求合法，节点会将其广播给其他节点，以便获得足够数量的预准备消息。**
4. **视图切换准备：**
   - **节点在收到足够数量的预准备消息后，可以生成视图切换准备消息并广播给其他节点。**
   - 视图切换准备消息中包含了足够数量的预准备消息的摘要。
5. **视图切换提交：**
   - **节点在收到足够数量的准备消息后，可以生成视图切换提交消息并广播给其他节点。**
   - 视图切换提交消息中包含了足够数量的准备消息的摘要。
6. **新视图的主节点选举：**
   - **当节点收到足够数量的视图切换提交消息后，可以认为新视图已经达成共识。**
   - 节点根据一定的规则从候选主节点中选择新的主节点，例如，**可以选择具有最高编号的节点作为新的主节点。**

需要注意的是，**视图切换是通过多数投票的方式完成的**。即系统中的节点需要达成一致，并广播足够数量的消息来确保选举结果的合法性。只有在新的主节点被选举出来后，系统才能进入新的视图并继续执行PBFT算法的各个阶段。

## 特点

优点：高速、可扩展。缺点：通常用于私有网络和许可网络。(f是有可能失效的副本的最大个数)

1. 计算效率依赖于参与协议的节点数量，不适用于节点数量过大的区块链系统，扩展性差。
2. 系统节点是固定的，无法应对公有链的开放环境，只适用于联盟链或私有链环境。
3. PBFT算法要求总节点数n>=3f+1(其中，f代表作恶节点数)。系统的失效节点数量不得超过全网节点的1/3，容错率相对较低
3. 尽管可以存在多于3f+1个副本，但是额外的副本除了降低性能之外不能提高可靠性。

## DBFT **授权拜占庭容错算法**

**在这个机制当中，存在两个参与者，一个是专业记账的“记账节点”，一个是系统当中的普通用户**。

**普通用户基于持有权益的比例来投票决定记账节点**，当**需要通过一项共识时，在这些记账节点中随机推选出一名发言人拟定方案**，然后由其他记账节点根据**拜占庭容错算法，即少数服从多数的原则进行表态，如果超过66%的节点表示同意发言人方案**，则共识达成；否则，重新推选发言人，重复投票过程。

**所以说，dBFT机制实际使用了一种迭代共识的方法来保证系统达成一致决定。**然而，**这种机制的缺点在于，当系统中有超过三分之一的记账节点停止工作时，整个区块链网络将无法提供正常的服务**；当超过三分之一的节点联合作恶时，区块链将有可能发生分叉。

