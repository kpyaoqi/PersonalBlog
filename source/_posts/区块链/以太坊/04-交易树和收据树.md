---
title: 04-交易树和收据树

date: 2022-09-23	

categories: 以太坊	

tags: [区块链,以太坊]
---	

# 交易树和收据树

每次发布一个区块时，区块中的交易会形成一颗Merkle Tree，即交易树。此外，以太坊还添加了一个收据树，每个交易执行完之后形成一个收据，记录交易相关信息。也就是说，交易树和收据树上的节点是**一一对应**的。
由于以太坊智能合约执行较为复杂，通过增加收据树，便于快速查询执行结果。
交易树和收据树都是**M(Merkle)PT**，MPT的好处是支持查找操作，通过键值沿着树进行查找即可。对于状态树，查找键值为**账户地址**；对于交易树和收据树，查找键值为交易在发布的**区块中的序号**。

交易树和收据树只将当前区块中的交易组织起来，而状态树将所有账户的状态都包含进去，无论这些账户是否与当前区块中交易有关系。
多个区块状态树共享节点，而交易树和收据树依照区块独立。

> 交易树和收据树的用途：
>
> 1. 向轻节点提供Merkle Proof。
> 2. 更加复杂的查找操作(例如：查找过去十天的交易；过去十天的众筹事件等)

# Bloom filter(布隆过滤器)

**特点：有可能出现误报，但不会出现漏报。**

> 例如：给定一个数据集，其中含义元素a、b、c，通过一个哈希函数H()对其进行计算，将其映射到一个其初始全为0的128位的向量的某个位置，将该位置置为1。将所有元素处理完，就可以得到一个向量，则称该向量为原集合的“摘要”。可见该“摘要”比原集合是要小很多的。
> 假定想要查询一个元素d是否在集合中，假设H(d)映射到向量中的位置处为0，说明d一定不在集合中；假设H(d)映射到向量中的位置处为1，有可能集合中确实有d，也有可能因为哈希碰撞产生误报。
>
> ![image-20230105104403727](/noteimg/C:/Users/zhuba/Desktop/PersonalBlog/source/_posts/区块链/以太坊/img/image-20230105104403727.png) 

**如果集合中删除元素该怎么操作？**
**无法操作**。也就是说，简单的Bloom filter不支持删除操作。如果想要支持删除操作，需要将记录数不能为0和1，需要修改为一个计数器(需要考虑计数器是否会溢出)。

### 以太坊中Bloom filter的作用

每个交易完成后会产生一个收据，收据包含一个Bloom filter记录交易类型、地址等信息。在区块block header中也包含一个Bloom filter，其为该区块中所有交易的Bloom filter的一个并集。
所以，查找时候**先查找块头中的Bloom filter**，如果块头中包含。**再查看区块中包含的交易的Bloom filter**，如果存在，再查看交易进行确认；如果不存在，则说明发生了“碰撞”。
好处是通过Bloom filter这样一个结构，**快速大量过滤掉大量无关区块，从而提高了查找效率。**